<!doctype html>
<html lang="en">

<head>
  <!-- <meta charset="utf-8"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-signin-client_id" content="640918568812-15p1vdvh51map3b1e4948q9romq66dpl.apps.googleusercontent.com">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <link rel="stylesheet" href="styles.css?version=1.8">
  <script src="storage.js?version=1.6"></script>
  <script src="objectDesign.js?version=1.6"></script>
  <script src="labels.js?version=1.6"></script>
  <script src="enums.js?version=1.6"></script>

  <style>
  </style>
</head>

<body class="page-background">
  <!-- <div class="g-signin2" data-onsuccess="onSignIn"></div>
  <a href="#" onclick="signOut();">Sign out</a> -->

  <div id="gbutton" class="g-signin2" style="display:none;" data-onsuccess="onSignIn" data-onfailure="onSignInFailure"></div>
  <div class="topbar not-selectable">
    <div id="profile" class="topbar-item" style="width: 100px" onclick="updateProfile()">Sync</div>
    <div id="back" class="topbar-item" style="display:none;" onclick="buttonBackClicked()">Back</div>
    <div type="pool-button" id="create" class="topbar-item" style="display:none;" onclick="buttonCreateClicked()">Create</div>
    <div type="topbar-button" id="rename" class="topbar-item" style="display:none;" onclick="buttonRenameClicked()">Rename</div>
    <div type="topbar-button" id="delete" class="topbar-item" style="width: 60px;display:none;" onclick="buttonDeleteClicked()">Delete</div>
  </div>

  <div id="workspace" class="container not-selectable">
    <div id="data" class="flex-item data-area">
    </div>
    <div id="controls" class="fixed">
      <div id="pool" class="button notselected" onclick="showPool()"></div>
      <div id="context" class="button notselected" onclick="toggleContext()">Labels</div>
      <div id="context" class="button notselected" onclick="showHelp()">Help</div>
    </div>
  </div>

  <!-- <div id="help" class="help-area text-area" style="display:none;">
    <div>SWGOH Labels</div>
    <div></div>
    <div>Account sync:</div>
    <div>This tool is designed to group SWGOH rosters, in order to have your roster available you should use the Profile button.</div>
    <div>Once you enter your swgoh.gg account name a sync will be performed in order to collect your roster.</div>
    <div>When you want your toons to be synced you should press that button and request the account ro (re)sync.</div>
    <div></div>
    <div>Labels</div>
    <div>Labels are your group of toons, the groups that exist in game (categories) and the groups you are allowed to create.</div>
    <div>Some usage examples of groups that can be created are teams that you use Raids, Territory Wars, Territory Battless, future
      farms, etc...</div>
    <div>To be able to create, remove and rename Labels you must sign-in using your google account. Once you have your own labels
      they will be available to you for any account you decide to sync.</div>
    <div>
      <div id="gbutton" class="g-signin2" data-onsuccess="onSignIn" data-onfailure="onSignInFailure"></div>
    </div>
    <div>Hello world</div>
  </div> -->

  <script>
    $(window).on('load', function () {
      main();
    })

    function showHelp() {
      if ($("div[id='data']").is(":visible")) {
        $("div[id='data']").hide();
        $("div[id='help']").show();
      }
      else {
        $("div[id='data']").show();
        $("div[id='help']").hide();
      }

    }

    function setStatus(status) {
      document.getElementById("profile").innerHTML = status;
    }

    function onSignIn(googleUser) {
      var profile = googleUser.getBasicProfile();
      console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
      console.log('Name: ' + profile.getName());
      console.log('Image URL: ' + profile.getImageUrl());
      console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.

      var idToken = googleUser.getAuthResponse().id_token;
      sessionStorage.setItem("signInToken", idToken);

      var idTokenValidationResult = sessionStorage.getItem(idToken);
      if (idTokenValidationResult != null) {
        console.log("User sign in token was already validated");
        return;
      }

      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://swgohlabels.com/services/auth.php');
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function () {
        console.log(xhr.responseText);
        if (this.readyState == 4 && this.status == 200) {
          //setStatus('Signed in');

          var idToken = sessionStorage.getItem("signInToken");
          sessionStorage.setItem(idToken, true);
          getData();
        }
      };
      console.log("sending idtoken");
      xhr.send('idtoken=' + idToken);
    }

    function onSignInFailure() {
      console.log("nah, not signed in!");
    }

    function signOut() {
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
    }

    function main() {
      $labels = null;
      $profile = localStorage.getItem("profile");
      $images = new Object();
      $pool = new Array();
      $workingMode = new workingMode();
      $context = new context();
      $selectedLabel = "";

      document.getElementById("context").innerHTML = $context.description;
      refreshPool();

      if ($profile == null)
        setStatus("Sync");
      else
        getData();
    }

    function ExecuteCommand(command, arguments, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://swgohlabels.com/services/auth.php');
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function () {
        if (this.readyState == 4 && this.status == 200) {
          callback(xhr.responseText);
        }
      };

      var parameters = "command=" + command;
      if (arguments != null)
        parameters += "&arguments=" + arguments;

      xhr.send(parameters);
    }

    function getJSON(url, callback) {
      getJSONWithParams(url, null, callback);
    };

    function getJSONWithParams(url, params, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'json';
      xhr.onload = function () {
        var status = xhr.status;
        if (xhr.status === 200) {
          callback(null, xhr.response);
        } else {
          callback(status, xhr.response);
        }
      };

      if (params != null)
        xhr.send(params);
      else
        xhr.send();
    }

    function getXML(url, callback) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          callback(this.responseText);
        }
      };
      xhttp.open("GET", url, true);
      xhttp.send();
    }

    function keepData(err, result) {
      if (err !== null) {
        alert('Something went wrong: ' + err);
        return;
      }

      $data = result;

      getXML(
        "https://script.google.com/macros/s/AKfycbxpqgsngbaUJ4xMl22o5VpAkz1oSpSzfIsw694CzfwyEc_GmeM/exec?user=" + $profile,
        addUserDataAndCreateIndex);
    }

    function addUserDataAndCreateIndex(result) {
      if (result == null) {
        alert('Something went wrong: ');
        return;
      }

      if (result == "error") {
        setStatus("Sync error!");
        console.log("correu mal");
        return;
      }

      var jsonResult = JSON.parse(result);

      for (var i = 0; i < $data.length; i++)
        if (jsonResult.hasOwnProperty($data[i].uniqueName))
          $data[i].instance = jsonResult[$data[i].uniqueName];

      $data.sort(compareDataElements);
      storeObjectInStorage('data', $data);
      localStorage.setItem('profile', $profile);
      dataIsReady();
    }

    function getData() {
      $data = getObjectFromStorage('data');

      // display objects
      if ($data != null) {
        dataIsReady();
      }
      else {
        setStatus("Syncing data...");
        clearLocalStorage();
        getJSON("https://raw.githubusercontent.com/jmiln/SWGoHBot/master/data/characters.json", keepData);
      }
    }

    function dataIsReady() {
      var authInstance = window.gapi.auth2.getAuthInstance();

      if (authInstance != null && authInstance.isSignedIn.get()) {
        ExecuteCommand("getUserLabels", null, function (response) {
          console.log(response);
          var userLabels = JSON.parse(response);
          storeObjectInStorage("userLabels", userLabels);

          $labels = new Labels($data);
          buildImagesIndex($data);
          displayObjects($data, $labels);
          filterAllToons();
          assignImages();
          setStatus($profile);
        });
      }
      else {
        $labels = new Labels($data);
        buildImagesIndex($data);
        displayObjects($data, $labels);
        filterAllToons();
        assignImages();
        setStatus($profile);
      }
    }

    function toggleWorkingMode() {
      $workingMode.toggle();
      document.getElementById("mode").innerHTML = $workingMode.description;
    }

    function toggleContext() {
      $context.toggle();
      contextUpdated();
    }

    function contextUpdated() {
      document.getElementById("context").innerHTML = $context.description;

      if ($context.value == $context.contexts.labels)
        filterAllLabels();
      else
        filterAllToons();
    }

    function resetContext() {
      if ($context.value == $context.contexts.labels)
        toggleContext();
    }

    function refreshPool() {
      document.getElementById("pool").innerHTML = $pool.length;
    }

    function assignImages() {
      // pre-load
      var preLoad = [];
      var lastIndex = Object.keys($images).length - 1;

      Object.keys($images).forEach(function (key, index) {
        var myImage = new Image();

        if (index == lastIndex) {
          myImage.onload = function () {
            showImages();
          }
        }


        myImage.src = $images[key].src;
        preLoad.push(myImage);
      });
    }

    function showImages() {
      var imgDefer = document.getElementsByTagName('img');
      for (var i = 0; i < imgDefer.length; i++) {
        if (imgDefer[i].getAttribute('data-src')) {
          imgDefer[i].setAttribute('src', imgDefer[i].getAttribute('data-src'));
        }
        if (imgDefer[i].getAttribute('data-style')) {
          imgDefer[i].setAttribute('style', imgDefer[i].getAttribute('data-style'));
        }
      }
    }

    function compareDataElements(a, b) {
      if (a.hasOwnProperty("instance") && b.hasOwnProperty("instance"))
        return b.instance.power - a.instance.power;
      if (a.hasOwnProperty("instance"))
        return -1;
      if (b.hasOwnProperty("instance"))
        return 1;
      return 0;
    }

    function displayObjects(data, labels) {
      var currentObjectsHTML = document.getElementById("data").innerHTML;
      var oldObjectsHTML = localStorage.getItem('oldObjectsHTML');
      var newHtml = "";

      // add objects
      for (var i = 0; i < data.length; i++)
        newHtml += getObjectDesign(data[i], $pool.indexOf(data[i].uniqueName) >= 0, true);

      // add labels
      newHtml += $labels.displayLabels();

      if ((currentObjectsHTML.length < 100) || (oldObjectsHTML != newHtml)) {
        // display synced objects
        document.getElementById("data").innerHTML = newHtml;
        
        // keep object's design for future requests
        localStorage.setItem('oldObjectsHTML', newHtml);
      }

      // update from pool
      
    }

    function buildImagesIndex(data) {
      var item;
      for (var i = 0; i < data.length; i++) {
        item = data[i];
        $images[item.uniqueName] = {};
        $images[item.uniqueName].src = "img" + item.avatarURL.slice(item.avatarURL.lastIndexOf('/'));
      }
    }

    function objectClicked(elem, id) {
      //if ($workingMode.value == $workingMode.workModes.select)
      addToPool(elem, id);
    }

    function labelClicked(label) {
      $selectedLabel = label;
      filterByLabel(label);
    }


    function addToPool(elem, id) {
      var index = $pool.indexOf(id);
      if (index > -1) {
        // unselect
        $pool.splice(index, 1);
        elem.className = "player-char-portrait char-portrait-full notselected";
      }
      else {
        //select
        $pool.push(id);
        elem.className = "player-char-portrait char-portrait-full selected";
      }
      refreshPool();
    }

    function buttonCreateClicked() {
      if (window.gapi.auth2.getAuthInstance().isSignedIn.get() == false) {
        //window.gapi.auth2.getAuthInstance().signIn().then(() => { signedInCreateLabel(label); });
        window.gapi.auth2.getAuthInstance().signIn().then(onSignIn);
        return;
      }
      else {
        var label = prompt("What is the label name?");

        if (label == null || label == "")
          return;

        signedInCreateLabel(label);
      }
    }

    function signedInCreateLabel(label) {
      // unselect objects
      for (var i = 0; i < $pool.length; i++) {
        $("div[id='data']").children("div[id='" + $pool[i] + "']").toggleClass("selected notselected");
      }

      // create label
      var newLabelHtml = $labels.createLabel(label, $pool);
      $pool = [];
      refreshPool();

      // add to displayed data
      document.getElementById("data").innerHTML = newLabelHtml + document.getElementById("data").innerHTML;

      // save the html for later sage
      localStorage.setItem('dataInnerHTML', document.getElementById("data").innerHTML);

      // save labels in the database
      ExecuteCommand("setUserLabels", JSON.stringify($labels.userLabels), getUserLabelsResult);

      $context.setLabels();
      contextUpdated();
    }

    function getUserLabelsResult(response) {
      console.log(response);
    }

    function updateProfile() {
      var profile = $profile;

      if (profile == null)
        profile = "";

      profile = prompt("Enter a swgoh.gg profile to fetch data:", profile);
      if (profile == null || profile == "") {
        return null;
      }

      document.getElementById("data").innerHTML = "";
      resetContext();
      $profile = profile;
      clearLocalStorage();
      getData();
      //setStatus($profile);
    }

    function buttonBackClicked() {
      // filterAllLabels();
      // hideLabelButtons();

      if ($selectedLabel == "") {
        toggleContext();
        hideLabelButtons();
        return;
      }

      var parent = $selectedLabel.substring(0, $selectedLabel.lastIndexOf('.'));

      $selectedLabel = parent;
      filterByLabel(parent);
    }

    function buttonDeleteClicked() {
      if (confirm("You're about to delete label '" + $selectedLabel + "'. Are you sure?") == false)
        return;

      if (window.gapi.auth2.getAuthInstance().isSignedIn.get() == false) {
        window.gapi.auth2.getAuthInstance().signIn().then(() => { deleteSelectedLabel(); });
        return;
      }
      else {
        deleteSelectedLabel();
      }
    }

    function buttonRenameClicked() {
      if (window.gapi.auth2.getAuthInstance().isSignedIn.get() == false) {
        window.gapi.auth2.getAuthInstance().signIn().then(() => { renameSelectedLabel(); });
        return;
      }
      else {
        renameSelectedLabel();
      }
    }

    function deleteSelectedLabel() {
      setStatus("updating data...");

      $labels.deleteLabel($selectedLabel);
      ExecuteCommand("setUserLabels", JSON.stringify($labels.userLabels), getUserLabelsResult);
      localStorage.removeItem('dataInnerHTML');

      displayObjects($data, $labels);
      filterAllLabels();
      assignImages();
      setStatus($profile);

    }

    function renameSelectedLabel() {
      var newName = prompt("Enter a new name to replace '" + $selectedLabel + "':", $selectedLabel);

      if (newName == null || newName == "")
        return;

      hideLabelButtons();
      setStatus("updating data...");
      $labels.renameLabel($selectedLabel, newName);
      $selectedLabel = newName;

      ExecuteCommand("setUserLabels", JSON.stringify($labels.userLabels), getUserLabelsResult);
      localStorage.removeItem('dataInnerHTML');

      displayObjects($data, $labels);
      filterAllLabels();
      assignImages();
      setStatus($profile);
    }


    function hideLabelButtons() {
      $("div[type='topbar-button']").hide();
      $("div[type='pool-button']").hide();
      $("div[id='profile']").show();
    }

    function filterByLabel(label) {
      $("div[id='profile']").hide();

      if ($labels.isUserLabel(label))
        $("div[type='topbar-button']").show();
      else
        $("div[id='back']").show();

      // hide all
      $("div[id='data']").children("div").hide();
      var labelObjectsIds = $labels.getLabelValue(label);

      // show selected div ids
      for (var i = 0; i < labelObjectsIds.length; i++)
        $("div[id='data']").children("div[id='" + labelObjectsIds[i] + "']").show();
    }

    function showPool() {
      $context.setLabels();
      contextUpdated();

      $("div[id='data']").children("div").hide();
      hideLabelButtons();
      $("div[id='profile']").hide();
      $("div[id='back']").show();
      $("div[id='create']").show();

      for (var i = 0; i < $pool.length; i++)
        $("div[id='data']").children("div[id='" + $pool[i] + "']").show();
    }

    function filterAllLabels() {
      hideLabelButtons();
      $selectedLabel = "";
      filterByLabel("");
    }

    function filterAllToons() {
      // hide all
      $("div[id='data']").children("div").show();
      $("div[id='profile']").show();
      $("div[id='back']").hide();
      $("div[id='create']").hide();

      var allLabels = $labels.getAllLabels();
      for (var property in allLabels)
        $("div[id='data']").children("div[id='" + property + "']").hide();
    }
  </script>
</body>

</html>